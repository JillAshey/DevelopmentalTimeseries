---
title: "GO enrichment"
author: "Jill Ashey"
date: "2024-12-28"
output: html_document
---

GO enrichment of Mcap miRNA targets that are decreasing as development progresses.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

devtools::install_github("stemangiola/tidyHeatmap")

library(tidyverse)
library(topGO)
library(tidyHeatmap)
```

Read in correlation data generated from mirTarRnaSeq 
```{r}
corr <- read.csv("../output/Molecular/miRNA_mRNA_interactions/mirtarrnaseq_correlations_data.csv")
head(corr)
```

Make df with only gene and miRNA info 
```{r}
corr_gene_mirna <- corr %>%
  dplyr::select(V1, V2) %>%
  dplyr::rename(mirna = V1, gene = V2) 
```

Read in annotation file and make tab file for topGO
```{r}
annot <- read.delim("~/Desktop/GFFs/mcap/V3/Montipora_capitata_HIv3.genes.EggNog_results.txt") %>%
  dplyr::select(X.query, GOs) %>%
  mutate(across(everything(), ~ na_if(., "-")))

# Make sure all GO terms are separated by ;
annot$GOs <- gsub(",", ";", annot$GOs)

write_tsv(annot, file = "../data/Molecular/Mcap_V3_gene2go.tab")
```

Make list of genes for input to topGO
```{r}
# Genes of interest - ie those targeted by miRNAs 
clust_genes <- as.character(corr_gene_mirna$gene)

# All genes 
all_genes <- as.character(annot$X.query)

# Apply 1 or 0 if gene is gene of interest 
GeneList <- factor(as.integer(all_genes %in% clust_genes))
names(GeneList) <- all_genes
```

The following code will perform GO enrichment using the weighted Fisher's exact test to assess whether specific GO terms are overrepresented in the genes targeted by miRNAs. 

Read in gene-to-go-mappings
```{r}
gene2go_topgo <- readMappings("../data/Molecular/Mcap_V3_gene2go.tab", IDsep=";")
```

Set function to select genes of interest (ie those that have pvalue < 0.05)
```{r}
topDiffGenes <- function(allScore) {
return(allScore < 0.05)}
```

### Biological Processes

Create `topGOdata` object, which is required for topGO analysis
```{r}
GO_BP <-new("topGOdata", ontology="BP", gene2GO=gene2go_topgo, allGenes=GeneList, annot = annFUN.gene2GO, geneSel=topDiffGenes)
```

Run GO enrichment test 
```{r}
GO_BP_FE <- runTest(GO_BP, algorithm="weight01", statistic="fisher")
```

Generate results table 
```{r}
GO_BP_En <- GenTable(GO_BP, Fisher = GO_BP_FE, orderBy = "Fisher", numChar = 51, topNodes = 100)
```

Filter by significant results
```{r}
GO_BP_En$Fisher<-as.numeric(GO_BP_En$Fisher)
GO_BP_En_sig<-GO_BP_En[GO_BP_En$Fisher<0.05,]
```

Merge `GO_BP_En_sig` with GO and gene info. 
```{r}
# Separate GO terms 
annot <- annot %>%
  separate_rows(GOs, sep = ";")

# Ensure GO terms in both datasets are formatted similarly (trim whitespaces)
annot$GOs <- trimws(annot$GOs)
GO_BP_En_sig$GO.ID <- trimws(GO_BP_En_sig$GO.ID)

# Join the datasets based on GO term
GO_BP_En_sig_gene <- annot %>%
  left_join(GO_BP_En_sig, by = c("GOs" = "GO.ID")) %>%
  na.omit()

# Add ontology column 
GO_BP_En_sig_gene$ontology <- "Biological Processes"
```

Merge with corr and miRNA data
```{r}
GO_BP_En_sig_gene_mirna <- GO_BP_En_sig_gene %>%
  full_join(corr, by = c("X.query" = "V2")) %>%
  na.omit()

length(unique(GO_BP_En_sig_gene_mirna$X.query))
length(unique(GO_BP_En_sig_gene_mirna$V1))
length(unique(GO_BP_En_sig_gene_mirna$GOs))
```

### Cellular Components 

Create `topGOdata` object, which is required for topGO analysis
```{r}
GO_CC <-new("topGOdata", ontology="CC", gene2GO=gene2go_topgo, allGenes=GeneList, annot = annFUN.gene2GO, geneSel=topDiffGenes)
```

Run GO enrichment test 
```{r}
GO_CC_FE <- runTest(GO_CC, algorithm="weight01", statistic="fisher")
```

Generate results table 
```{r}
GO_CC_En <- GenTable(GO_CC, Fisher = GO_CC_FE, orderBy = "Fisher", numChar = 51, topNodes = 100)
```

Filter by significant results
```{r}
GO_CC_En$Fisher<-as.numeric(GO_CC_En$Fisher)
GO_CC_En_sig<-GO_CC_En[GO_CC_En$Fisher<0.05,]
```

Merge `GO_CC_En_sig` with GO and gene info. 
```{r}
# Separate GO terms 
# annot <- annot %>%
#   separate_rows(GOs, sep = ";")

# Ensure GO terms in both datasets are formatted similarly (trim whitespaces)
# annot$GOs <- trimws(annot$GOs)
GO_CC_En_sig$GO.ID <- trimws(GO_CC_En_sig$GO.ID)

# Join the datasets based on GO term
GO_CC_En_sig_gene <- annot %>%
  left_join(GO_CC_En_sig, by = c("GOs" = "GO.ID")) %>%
  na.omit()

# Add ontology column 
GO_CC_En_sig_gene$ontology <- "Cellular Components"
```

Merge with corr and miRNA data
```{r}
GO_CC_En_sig_gene_mirna <- GO_CC_En_sig_gene %>%
  full_join(corr, by = c("X.query" = "V2")) %>%
  na.omit()

length(unique(GO_CC_En_sig_gene_mirna$X.query))
length(unique(GO_CC_En_sig_gene_mirna$V1))
length(unique(GO_CC_En_sig_gene_mirna$GOs))
```

### Molecular Functions

Create `topGOdata` object, which is required for topGO analysis
```{r}
GO_MF <-new("topGOdata", ontology="MF", gene2GO=gene2go_topgo, allGenes=GeneList, annot = annFUN.gene2GO, geneSel=topDiffGenes)
```
Run GO enrichment test 
```{r}
GO_MF_FE <- runTest(GO_MF, algorithm="weight01", statistic="fisher")
```

Generate results table 
```{r}
GO_MF_En <- GenTable(GO_MF, Fisher = GO_MF_FE, orderBy = "Fisher", numChar = 51, topNodes = 100)
```

Filter by significant results
```{r}
GO_MF_En$Fisher<-as.numeric(GO_MF_En$Fisher)
GO_MF_En_sig<-GO_MF_En[GO_MF_En$Fisher<0.05,]
```

Merge `GO_MF_En_sig` with GO and gene info. 
```{r}
# Separate GO terms 
# annot <- annot %>%
#   separate_rows(GOs, sep = ";")

# Ensure GO terms in both datasets are formatted similarly (trim whitespaces)
# annot$GOs <- trimws(annot$GOs)
GO_MF_En_sig$GO.ID <- trimws(GO_MF_En_sig$GO.ID)

# Join the datasets based on GO term
GO_MF_En_sig_gene <- annot %>%
  left_join(GO_MF_En_sig, by = c("GOs" = "GO.ID")) %>%
  na.omit()

# Add ontology column 
GO_MF_En_sig_gene$ontology <- "Molecular Functions"
```

Merge with corr and miRNA data
```{r}
GO_MF_En_sig_gene_mirna <- GO_MF_En_sig_gene %>%
  full_join(corr, by = c("X.query" = "V2")) %>%
  na.omit()

length(unique(GO_MF_En_sig_gene_mirna$X.query))
length(unique(GO_MF_En_sig_gene_mirna$V1))
length(unique(GO_MF_En_sig_gene_mirna$GOs))
```

### Join ontologies 

Bind so there is a df that has significantly enriched GO terms for all ontologies 
```{r}
GO_En_sig_gene_mirna <- rbind(GO_BP_En_sig_gene_mirna, GO_CC_En_sig_gene_mirna, GO_MF_En_sig_gene_mirna)

# Calculate proportion of significant v annotated genes 
GO_En_sig_gene_mirna <- GO_En_sig_gene_mirna %>%
  mutate(sig.prop = Significant/Annotated) %>%
  na.omit()

# Save as csv 
write.csv(GO_En_sig_gene_mirna, "../output/Molecular/miRNA_mRNA_interactions/GO_en_sig_miRNA_targets.csv")
```

Plot BP and MF only 
```{r}
GO_En_sig_gene_mirna_bp <- GO_En_sig_gene_mirna %>%
  dplyr::filter(ontology == "Biological Processes") #%>%
  #dplyr::filter(V1 == "Montipora_capitata_HIv3___Scaffold_8_586427")

bp_plot<-ggplot(GO_En_sig_gene_mirna_bp, aes(x = Term, y = Fisher, fill = Fisher, size = sig.prop)) +
  #expand_limits(y = 1.5) +
  #ylim(1, 7.25) +
  # Add horizontal lines with a single aesthetic value
  #geom_hline(yintercept = -log10(0.01), linetype = "longdash", colour = "black", linewidth = .6) +
  #geom_hline(yintercept = -log10(0.001), linetype = "solid", colour = "black", linewidth = .6) +
  geom_point(shape = 21) + 
  #scale_size(range = c(2, 12)) + 
  scale_fill_continuous(low = "#1AD3D1FF", high = "#4686FBFF") +
  xlab('') + 
  ylab('Enrichment score') +
  #labs(caption = 'Cut-off lines at p=0.01 and p=0.001') +
  theme_bw() +
  facet_grid(vars(ontology), scales = "free", space = "free_y") +
  coord_flip(); bp_plot
ggsave("../output/Molecular/miRNA_mRNA_interactions/GO_en_sig_miRNA_targets_BP.pdf", plot = bp_plot, height = 25, width = 20)
ggsave("../output/Molecular/miRNA_mRNA_interactions/GO_en_sig_miRNA_targets_BP.png", plot = bp_plot, height = 25, width = 20)

GO_En_sig_gene_mirna_mf <- GO_En_sig_gene_mirna %>%
  dplyr::filter(ontology == "Molecular Functions") #%>%
  #dplyr::filter(V1 == "Montipora_capitata_HIv3___Scaffold_8_586427")

mf_plot<-ggplot(GO_En_sig_gene_mirna_mf, aes(x = Term, y = Fisher, fill = Fisher, size = sig.prop)) +
  #expand_limits(y = 1.5) +
  #ylim(1, 7.25) +
  # Add horizontal lines with a single aesthetic value
  #geom_hline(yintercept = -log10(0.01), linetype = "longdash", colour = "black", linewidth = .6) +
  #geom_hline(yintercept = -log10(0.001), linetype = "solid", colour = "black", linewidth = .6) +
  geom_point(shape = 21) + 
  #scale_size(range = c(2, 12)) + 
  scale_fill_continuous(low = "#1AD3D1FF", high = "#4686FBFF") +
  xlab('') + 
  ylab('Enrichment score') +
  #labs(caption = 'Cut-off lines at p=0.01 and p=0.001') +
  theme_bw() +
  facet_grid(vars(ontology), scales = "free", space = "free_y") +
  coord_flip(); mf_plot
ggsave("../output/Molecular/miRNA_mRNA_interactions/GO_en_sig_miRNA_targets_MF.pdf", plot = mf_plot, height = 25, width = 20)
ggsave("../output/Molecular/miRNA_mRNA_interactions/GO_en_sig_miRNA_targets_MF.png", plot = mf_plot, height = 25, width = 20)
```

```{r}
# Set input
GO_En_sig_gene_mirna$Term <- as.factor(GO_En_sig_gene_mirna$Term)
GO_En_sig_gene_mirna$V1 <- as.factor(GO_En_sig_gene_mirna$V1)
GO_En_sig_gene_mirna$Fisher <- as.double(GO_En_sig_gene_mirna$Fisher)

# subset 
sub <- GO_En_sig_gene_mirna %>%
  dplyr::select(Term, V1, Fisher) 

blah <- sub %>%
  heatmap(V1, Term, Fisher, scale = "row"); blah
```



```{r}
mtcars_tidy <- 
    mtcars |> 
    as_tibble(rownames="Car name") |> 
    
    # Scale
    mutate_at(vars(-`Car name`, -hp, -vs), scale) |>
    
    # tidyfy
    pivot_longer(cols = -c(`Car name`, hp, vs), names_to = "Property", values_to = "Value")

mtcars_tidy

mtcars_heatmap <- 
    mtcars_tidy %>%
    heatmap(`Car name`, Property, Value,    scale = "row"   ) %>%
    annotation_tile(hp); mtcars_heatmap
```



